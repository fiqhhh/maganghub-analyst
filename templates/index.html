<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagangHub Simple Explorer</title>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f8f9fa; color: #343a40; }
        .container { max-width: 1000px; margin: auto; background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { color: #007bff; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        th { background-color: #e9ecef; cursor: pointer; color: #495057; }
        tr:hover { background-color: #f1f1f1; }
        .loading { text-align: center; margin: 30px 0; font-weight: bold; color: #28a745; }
        .peluang-tinggi { background-color: #d4edda; } /* Hijau Muda */
        .peluang-rendah { background-color: #f8d7da; } /* Merah Muda */
        .link-detail { text-decoration: none; color: white; background-color: #007bff; padding: 5px 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <h1>MagangHub Lowongan Aktif (DKI Jakarta)</h1>
    <p>Data diambil langsung dari API MagangHub. Total lowongan akan terisi setelah dimuat.</p>

    <div id="loading" class="loading">
        ⏳ Mengambil semua data MagangHub... Ini mungkin memakan waktu 1–2 menit.
    </div>

    <table id="lowongan-table" style="display:none;">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Posisi ↕️</th>
                <th onclick="sortTable(1)">Perusahaan ↕️</th>
                <th onclick="sortTable(2)">Kuota ↕️</th>
                <th onclick="sortTable(3)">Pendaftar ↕️</th>
                <th onclick="sortTable(4)">Peluang (%) ↕️</th>
                <th>Detail</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    let lowonganData = [];
    const MAGANGHUB_BASE_LINK = 'https://maganghub.kemnaker.go.id/lowongan/view/';

    function displayLowongan(data) {
        const tbody = document.getElementById('lowongan-table').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        data.forEach(item => {
            let row = tbody.insertRow();
            
            let colorClass = '';
            if (item.peluang >= 5) {
                colorClass = 'peluang-tinggi';
            } else if (item.peluang < 1) {
                colorClass = 'peluang-rendah';
            }
            row.className = colorClass;

            row.insertCell().innerHTML = item.posisi;
            row.insertCell().innerHTML = item.perusahaan;
            row.insertCell().innerHTML = item.kuota;
            row.insertCell().innerHTML = item.pendaftar;
            row.insertCell().innerHTML = item.peluang.toFixed(2) + '%';
            
            // Kolom Link Detail
            row.insertCell().innerHTML = `<a href="${MAGANGHUB_BASE_LINK + item.id}" target="_blank" class="link-detail">Lihat</a>`;
        });
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('lowongan-table').style.display = 'table';
    }
    
    // Fungsi untuk Sorting Tabel
    let sortColumn = 4; // Default sort column (Peluang)
    let sortDir = "desc";

    function sortTable(n) {
        const table = document.getElementById("lowongan-table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.rows);
        
        if (sortColumn === n) {
            sortDir = sortDir === "asc" ? "desc" : "asc";
        } else {
            sortDir = "desc";
            sortColumn = n;
        }

        const isNumeric = n >= 2 && n <= 4; 

        rows.sort((rowA, rowB) => {
            let x = rowA.cells[n].textContent;
            let y = rowB.cells[n].textContent;

            // Bersihkan dan konversi nilai jika numerik
            if (isNumeric) {
                x = parseFloat(x.replace('%', ''));
                y = parseFloat(y.replace('%', ''));
            } else {
                x = x.toLowerCase();
                y = y.toLowerCase();
            }

            let comparison = 0;
            if (x > y) {
                comparison = 1;
            } else if (x < y) {
                comparison = -1;
            }
            
            return sortDir === "asc" ? comparison : comparison * -1;
        });

        // Hapus dan masukkan kembali baris yang sudah diurutkan
        rows.forEach(row => tbody.appendChild(row));
    }


    // --- INITIAL DATA LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loading').style.display = 'block';
        
        fetch('/api/data')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Gagal mengambil data dari server. Coba muat ulang.');
                }
                return response.json();
            })
            .then(data => {
                lowonganData = data;
                if (lowonganData.length > 0) {
                    // Tampilkan data, sudah diurutkan dari backend (peluang tertinggi)
                    displayLowongan(lowonganData); 
                } else {
                    document.getElementById('loading').innerHTML = 'Tidak ada lowongan aktif yang ditemukan saat ini.';
                }
            })
            .catch(error => {
                document.getElementById('loading').innerHTML = '❌ ERROR: ' + error.message;
                console.error('Error fetching data:', error);
            });
    });

</script>

</body>
</html>